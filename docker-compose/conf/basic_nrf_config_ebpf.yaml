################################################################################
# Licensed to the OpenAirInterface (OAI) Software Alliance under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The OpenAirInterface Software Alliance licenses this file to You under
# the OAI Public License, Version 1.1  (the "License"); you may not use this file
# except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.openairinterface.org/?page_id=698
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#-------------------------------------------------------------------------------
# For more information about the OpenAirInterface (OAI) Software Alliance:
#      contact@openairinterface.org
################################################################################

# OAI CN Configuration File
### This file can be used by all OAI NFs
### Some fields are specific to an NF and will be ignored by other NFs
### The {{ env['ENV_NAME'] }} syntax lets you define these values in a docker-compose file
### If you intend to mount this file or use a bare-metal deployment, please refer to README.md
### The README.md also defines default values and allowed values for each configuration parameter

############# Common configuration

# Log level for all the NFs
log_level:
  general: debug

# If you enable registration, the other NFs will use the NRF discovery mechanism
register_nf:
  general: yes

http_version: 2

############## SBI Interfaces
### Each NF takes its local SBI interfaces and remote interfaces from here, unless it gets them using NRF discovery mechanisms
nfs:
  amf:
    host: oai-amf
    sbi:
      port: 8080
      api_version: v1
      interface_name: eth0
    n2:
      interface_name: eth0
      port: 38412
  smf:
    host: oai-smf
    sbi:
      port: 8080
      api_version: v1
      interface_name: eth0
    n4:
      interface_name: eth0
      port: 8805
  upf:
    host: oai-upf
    sbi:
      port: 8080
      api_version: v1
      interface_name: demo-oai
    n3:
      interface_name: demo-n3
      port: 2152
    n4:
      interface_name: demo-oai
      port: 8805
    n6:
      interface_name: demo-n6
    n9:
      interface_name: demo-n9
      port: 2152
  udm:
    host: oai-udm
    sbi:
      port: 8080
      api_version: v1
      interface_name: eth0
  udr:
    host: oai-udr
    sbi:
      port: 8080
      api_version: v1
      interface_name: eth0
  ausf:
    host: oai-ausf
    sbi:
      port: 8080
      api_version: v1
      interface_name: eth0
  nrf:
    host: oai-nrf
    sbi:
      port: 8080
      api_version: v1
      interface_name: eth0

#### Common for UDR and AMF
database:
  host: mysql
  user: test
  type: mysql
  password: test
  database_name: oai_db
  generate_random: true
  connection_timeout: 300 # seconds

## general single_nssai configuration
## Defines YAML anchors, which are reused in the config file
snssais:
  - &embb_slice1
    sst: 1
  - &embb_slice2
    sst: 1
    sd: 000001 # in hex
  - &hmtc_slice1
    sst: 5
  - &custom_slice
    sst: 222
    sd: 00007B # in hex

############## NF-specific configuration
amf:
  amf_name: "OAI-AMF"
  # This really depends on if we want to keep the "mini" version or not
  support_features_options:
    enable_simple_scenario: no # "no" by default with the normal deployment scenarios with AMF/SMF/UPF/AUSF/UDM/UDR/NRF.
                               # set it to "yes" to use with the minimalist deployment scenario (including only AMF/SMF/UPF) by using the internal AUSF/UDM implemented inside AMF.
                               # There's no NRF in this scenario, SMF info is taken from "nfs" section.
    enable_nssf: no
    enable_smf_selection: yes
  relative_capacity: 30
  statistics_timer_interval: 20  # in seconds
  emergency_support: false
  served_guami_list:
    - mcc: 208
      mnc: 95
      amf_region_id: 01
      amf_set_id: 001
      amf_pointer: 01
    - mcc: 001
      mnc: 01
      amf_region_id: 01
      amf_set_id: 001
      amf_pointer: 01
  plmn_support_list:
    - mcc: 208
      mnc: 95
      tac: 0xa000
      nssai:
        - *embb_slice1
        - *embb_slice2
        - *hmtc_slice1
        - *custom_slice
  supported_integrity_algorithms:
    # - "NIA0"
    - "NIA1"
    - "NIA2"
  supported_encryption_algorithms:
    # - "NEA0"
    - "NEA1"
    - "NEA2"

smf:
  ue_mtu: 1500
  support_features:
    use_local_subscription_info: yes # Use infos from local_subscription_info or from UDM
    use_local_pcc_rules: yes # Use infos from local_pcc_rules or from PCF
  # we resolve from NRF, this is just to configure usage_reporting
  upfs:
    - host: oai-upf
      config:
        enable_usage_reporting: no
  ue_dns:
    primary_ipv4: "172.21.3.100"
    primary_ipv6: "2001:4860:4860::8888"
    secondary_ipv4: "8.8.8.8"
    secondary_ipv6: "2001:4860:4860::8888"
  ims:
    pcscf_ipv4: "127.0.0.1"
    pcscf_ipv6: "fe80::7915:f408:1787:db8b"
  # the DNN you configure here should be configured in "dnns"
  # follows the SmfInfo datatype from 3GPP TS 29.510
  smf_info:
    sNssaiSmfInfoList:
      - sNssai: *embb_slice1
        dnnSmfInfoList:
          - dnn: "oai"
      - sNssai: *embb_slice2
        dnnSmfInfoList:
          - dnn: "oai.ipv4"
      - sNssai: *custom_slice
        dnnSmfInfoList:
          - dnn: "default"
          - dnn: "ethernet"
      - sNssai: *hmtc_slice1
        dnnSmfInfoList:
          - dnn: "ethernet"
  local_subscription_infos:
    - single_nssai: *embb_slice1
      dnn: "oai"
      qos_profile:
        5qi: 9
        session_ambr_ul: "200Mbps"
        session_ambr_dl: "400Mbps"
    - single_nssai: *embb_slice2
      dnn: "oai.ipv4"
      qos_profile:
        5qi: 9
        session_ambr_ul: "100Mbps"
        session_ambr_dl: "200Mbps"
    - single_nssai: *custom_slice
      dnn: "default"
      qos_profile:
        5qi: 9
        session_ambr_ul: "50Mbps"
        session_ambr_dl: "100Mbps"
    - single_nssai: *custom_slice
      dnn: "ethernet"
      qos_profile:
        5qi: 9
        session_ambr_ul: "50Mbps"
        session_ambr_dl: "100Mbps"
    - single_nssai: *hmtc_slice1
      dnn: "ethernet"
      qos_profile:
        5qi: 82
        session_ambr_ul: "10Mbps"
        session_ambr_dl: "10Mbps"

upf:
  # ===========================================================================
  # FEATURE FLAGS
  # ===========================================================================
  support_features:
    # BPF/XDP Data Plane: Use eBPF/XDP for high-performance packet processing
    # If disabled, simpleswitch (legacy) datapath is used
    # Recommendation: Always enable for production (10x+ better performance)
    enable_bpf_datapath: yes
    
    # QoS Enforcement: Enable TC-BPF for per-flow QoS (rate limiting, prioritization)
    # Maps to 3GPP PFCP: QER (QoS Enforcement Rule) IE
    # Requires enable_bpf_datapath: yes
    enable_qos: yes
    
    # Source NAT: Translate UE IP to N6 interface IP
    # Use when UE IPs are not routable in data network
    enable_snat: no
    
    # Framed Routing: Route traffic based on UE IP pools
    # (Typically used with RADIUS/AAA integration)
    enable_fr: no
    
    # Ethernet PDU Sessions: Support non-IP (Layer 2) PDU sessions
    # Required for 5G LAN, TSN, or industrial use cases
    enable_eth_pdu: no

  # Remote N6 gateway (Data Network gateway)
  # Used for ARP resolution and default route in data network
  remote_n6_gw: oai-ext-dn

  # ===========================================================================
  # BPF MAP CAPACITY CONFIGURATION
  # ===========================================================================
  # These parameters control eBPF map sizes and directly affect:
  #   - Maximum capacity (sessions, rules, flows)
  #   - Memory consumption
  #   - Performance characteristics
  #
  # Memory estimation formula (approximate):
  #   Per-session memory = 1KB + (PDRs×256B) + (QERs×128B) + (SDFs×(128B+filter_size))
  #   Total memory ≈ max_pfcp_sessions × per-session memory
  #
  # Deployment size examples:
  #   Small/Test:  max_pfcp_sessions=100,    memory~50-100MB
  #   Medium:      max_pfcp_sessions=10000,  memory~1-2GB
  #   Large:       max_pfcp_sessions=50000,  memory~5-10GB
  #   Enterprise:  max_pfcp_sessions=100000, memory~10-20GB
  # ===========================================================================
  
  # ---------------------------------------------------------------------------
  # SESSION CAPACITY (3GPP TS 29.244 - PFCP Session Establishment)
  # ---------------------------------------------------------------------------
  # Maximum concurrent PFCP sessions (PDU sessions)
  # Each PFCP session represents one UE's data connection (PDU session)
  # 
  # Corresponds to 3GPP IE: CP F-SEID (PFCP Session)
  # 
  # Sizing guide:
  #   - Small network:     100-1,000 sessions
  #   - Medium network:    1,000-10,000 sessions
  #   - Large network:     10,000-100,000 sessions
  #   - Per UE typically:  1-2 PDU sessions (default + dedicated)
  #
  # Default: 100 (suitable for testing/small deployments)
  # Range: 1-100,000
  max_pfcp_sessions: 100

  # ---------------------------------------------------------------------------
  # PFCP RULES PER SESSION (3GPP TS 29.244 Section 7.5.2)
  # ---------------------------------------------------------------------------
  
  # Maximum PDRs (Packet Detection Rules) per PDU session
  # PDRs define how to detect and classify packets
  # 
  # Corresponds to 3GPP IE: Create PDR (mandatory in Session Establishment)
  # 
  # Typical usage per session:
  #   - Minimum: 2 PDRs (uplink + downlink)
  #   - Normal:  2-4 PDRs (UL/DL for default bearer + dedicated bearers)
  #   - Complex: 4-8 PDRs (multiple service flows with different QoS)
  #
  # 
  # Default: 8
  # Range: 1-64
  max_pdrs_per_pdu_session: 8

  # Maximum FARs (Forwarding Action Rules) per PDU session
  # FARs define what to do with matched packets (forward, drop, buffer)
  # 
  # Corresponds to 3GPP IE: Create FAR (mandatory in Session Establishment)
  # 
  # Typical usage:
  #   - Usually matches PDR count (each PDR → FAR)
  #   - Range: Same as PDRs (1:1 mapping typical)
  #
  # Default: 8
  # Range: 1-64
  max_fars_per_pdu_session: 8

  # Maximum QERs (QoS Enforcement Rules) per PDU session
  # QERs define QoS treatment (bandwidth limits, scheduling)
  # 
  # Corresponds to 3GPP IE: Create QER (conditional on QoS requirements)
  # 
  # Typical usage per session:
  #   - Minimum: 1 QER (default QoS flow)
  #   - Normal:  1-2 QERs (default + one guaranteed bitrate flow)
  #   - Maximum: Up to 8 QERs (multiple prioritized flows)
  #
  # Note: Only used if enable_qos: yes
  # 
  # Default: 8
  # Range: 1-32
  max_qers_per_pdu_session: 8

  # Maximum URRs (Usage Reporting Rules) per PDU session
  # URRs define when and how to report usage (volume, time)
  # 
  # Corresponds to 3GPP IE: Create URR (conditional on charging/reporting)
  # 
  # Typical usage:
  #   - 0-1 URR for most sessions (if no usage reporting)
  #   - 1-2 URRs for charged sessions (volume + time triggers)
  #   - More URRs for complex charging scenarios
  #
  # Default: 4
  # Range: 0-16
  max_urrs_per_pdu_session: 4

  # Maximum BARs (Buffering Action Rules) per PDU session
  # BARs define buffering behavior during handover or state transitions
  # 
  # Corresponds to 3GPP IE: Create BAR (conditional on buffering requirements)
  # 
  # Typical usage:
  #   - 0 BARs for most sessions (no buffering)
  #   - 1 BAR for handover support
  #   - Rarely >1 BAR per session
  #
  # Default: 2
  # Range: 0-8
  max_bars_per_pdu_session: 2

  # ---------------------------------------------------------------------------
  # TRAFFIC CLASSIFICATION (3GPP TS 29.244 Section 7.5.2.2)
  # ---------------------------------------------------------------------------
  
  # Maximum SDF (Service Data Flow) filters per PDU session
  # SDF filters classify traffic within QoS flows (by IP, port, protocol)
  # 
  # Corresponds to 3GPP IE: SDF Filter (within Create PDR)
  # 
  # Typical usage per session:
  #   - Simple:  1-2 SDFs (default + one app-specific)
  #   - Normal:  2-4 SDFs (multiple apps with different treatment)
  #   - Complex: 4-8 SDFs (fine-grained traffic steering)
  #
  # Examples:
  #   - "All traffic": permit in/out from any to assigned
  #   - "HTTP/HTTPS": permit out 80 from 10.0.0.0/8 to assigned
  #   - "Video streaming": permit out from 203.0.113.0/24 to assigned
  #
  # Default: 8
  # Range: 1-32
  max_sdf_filters_per_pdu_session: 8

  # Maximum string length for SDF filter descriptions (in bytes)
  # SDF filters can contain complex match expressions
  # 
  # Example SDF filter string:
  #   "permit out ip from 10.0.0.0/8 80 to assigned"
  # 
  # Buffer must accommodate:
  #   - IP addresses/ranges
  #   - Port numbers/ranges
  #   - Protocol specifications
  #   - Permit/deny actions
  #
  # Default: 512 bytes (sufficient for most filters)
  # Range: 64-2048 bytes
  max_sdf_filter_string_length: 512

  # ---------------------------------------------------------------------------
  # NETWORK INTERFACE LIMITS
  # ---------------------------------------------------------------------------
  
  # Maximum network interfaces UPF can manage
  # Includes: N3 (GTP-U), N4 (PFCP), N6 (Data Network), N9 (inter-UPF)
  # 
  # Typical deployment:
  #   - Simple:  3-4 interfaces (N3, N4, N6, management)
  #   - Complex: 6-8 interfaces (multiple N6, N9 for UL-CL/branching)
  #
  # Default: 4
  # Range: 2-16
  max_upf_interfaces: 4

  # Maximum interfaces for traffic redirection (egress interfaces)
  # Used in FARs for forwarding packets to specific destinations
  # 
  # Corresponds to 3GPP IE: Forwarding Parameters (in Create FAR)
  #   - Outer Header Creation
  #   - Destination Interface
  # 
  # Must be ≤ max_upf_interfaces
  # 
  # Default: 2
  # Range: 1-max_upf_interfaces
  max_upf_redirect_interfaces: 2

  # ---------------------------------------------------------------------------
  # ARP/NEIGHBOR DISCOVERY
  # ---------------------------------------------------------------------------
  
  # Maximum ARP/ND (Neighbor Discovery) entries
  # Used for MAC address resolution in data network (N6)
  # 
  # Sizing guide:
  #   - Number of next-hop gateways in data network
  #   - Typically: 10-100 for small networks
  #   - Large deployments: 256-1024
  #
  # Default: 256
  # Range: 2-4096
  max_arp_entries: 256

  # ---------------------------------------------------------------------------
  # ADDITIONAL PFCP IE-RELATED PARAMETERS (For Future Usage)
  # ---------------------------------------------------------------------------
  
  # Maximum Application IDs per session
  # Used for application detection and reporting
  # 
  # Corresponds to 3GPP IE: Application ID (in PDR/URR)
  # 
  # Default: 8
  # Range: 0-32
  max_application_ids_per_session: 8

  # Maximum Traffic Endpoints per session
  # Used for multi-access PDU sessions (3GPP R16+)
  # Each endpoint represents a different access network
  # 
  # Corresponds to 3GPP IE: Traffic Endpoint ID
  # 
  # Default: 2 (typically 2 access networks max)
  # Range: 1-4
  max_traffic_endpoints_per_session: 2

  # Maximum Ethernet packet filters per session
  # Used for Ethernet PDU sessions (Layer 2)
  # Only relevant if enable_eth_pdu: yes
  # 
  # Corresponds to 3GPP IE: Ethernet Packet Filter (in PDR)
  # 
  # Default: 4
  # Range: 0-16
  max_ethernet_packet_filters_per_session: 4

  # Maximum redundant transmission parameters per session
  # Used for ultra-reliable communications (URLLC)
  # 
  # Corresponds to 3GPP IE: Redundant Transmission Parameters
  # 
  # Default: 0 (disabled by default)
  # Range: 0-4
  max_redundant_transmission_params_per_session: 0

  # ===========================================================================
  # DEPLOYMENT-SPECIFIC EXAMPLES
  # ===========================================================================
  # Uncomment the configuration that matches your deployment size:
  
  # # SMALL DEPLOYMENT (testing, PoC, <100 UEs)
  # max_pfcp_sessions: 100
  # max_pdrs_per_pdu_session: 4
  # max_qers_per_pdu_session: 4
  # max_sdf_filters_per_pdu_session: 4
  # max_arp_entries: 64
  # # Estimated memory: ~50MB
  
  # # MEDIUM DEPLOYMENT (enterprise, campus, <10K UEs)
  # max_pfcp_sessions: 10000
  # max_pdrs_per_pdu_session: 8
  # max_qers_per_pdu_session: 8
  # max_sdf_filters_per_pdu_session: 8
  # max_arp_entries: 512
  # # Estimated memory: ~1-2GB
  
  # # LARGE DEPLOYMENT (service provider, <100K UEs)
  # max_pfcp_sessions: 50000
  # max_pdrs_per_pdu_session: 8
  # max_qers_per_pdu_session: 8
  # max_sdf_filters_per_pdu_session: 8
  # max_arp_entries: 2048
  # # Estimated memory: ~5-10GB

################################################################################
# NOTES AND BEST PRACTICES
################################################################################
# 
# 1. MEMORY PLANNING:
#    - Monitor actual memory usage: watch -n1 'ps aux | grep upf'
#    - eBPF maps are allocated at startup (not dynamic)
#    - Rule of thumb: 1-2KB per session + (PDRs×QERs×SDFs overhead)
#
# 2. CAPACITY PLANNING:
#    - Start conservative, monitor, then increase
#    - Leave 20-30% headroom for bursts
#    - Consider peak hour traffic, not average
#
# 3. VALIDATION:
#    - UPF validates all parameters at startup
#    - Invalid values will prevent UPF from starting
#    - Check logs for detailed validation errors
#
# 4. DERIVED MAP SIZES (calculated automatically):
#    - rules_match_pdr_map = max_pfcp_sessions × max_pdrs_per_pdu_session
#    - session_qos_enabled_map = max_pfcp_sessions
#    - sdf_filters_map = max_pfcp_sessions × max_sdf_filters_per_pdu_session
#
# 5. 3GPP COMPLIANCE:
#    - All parameters based on 3GPP TS 29.244 (PFCP)
#    - IE names in comments reference specification
#    - Defaults follow 3GPP recommendations where applicable
#
################################################################################

# ===========================================================================
  # UPF INFO (3GPP TS 29.510 - NRF Registration)
  # ===========================================================================
  # Advertises UPF capabilities to NRF for SMF discovery
  upf_info:
    sNssaiUpfInfoList:
      - sNssai: *embb_slice1
        dnnUpfInfoList:
          - dnn: "oai"
      - sNssai: *embb_slice2
        dnnUpfInfoList:
          - dnn: "oai.ipv4"
      - sNssai: *custom_slice
        dnnUpfInfoList:
          - dnn: "default"
          - dnn: "ethernet"
      - sNssai: *hmtc_slice1
        dnnUpfInfoList:
          - dnn: "ethernet"

## DNN configuration
dnns:
  - dnn: "oai"
    pdu_session_type: "IPV4"
    ipv4_subnet: "12.1.1.128/25"
  - dnn: "oai.ipv4"
    pdu_session_type: "IPV4"
    ipv4_subnet: "12.1.1.64/26"
  - dnn: "default"
    pdu_session_type: "IPV4"
    ipv4_subnet: "12.1.1.0/26"
  - dnn: "ims"
    pdu_session_type: "IPV4V6"
    ipv4_subnet: "14.1.1.2/24"
  - dnn: "ethernet"
    pdu_session_type: "ETHERNET"
    ipv4_subnet: "12.1.1.0/26"
